<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>NutriPOS â€“ Receipt</title>
  <link rel="stylesheet" href="style.css"/>

</head>
<body>
  <div class="receipt">
    <div class="meta">
      <div><strong>Receipt</strong> <span id="orderNo"></span></div>
      <div id="createdAt"></div>
    </div>

    <div class="btns">
      <button id="printBtn">Print</button>
      <button id="copyBtn"> Copy QR payload</button>
    </div>

    <div class="nutri" id="nutri">
      <!-- nutrition summary injected here -->
    </div>

    <div id="itemsWrap" style="display:none;">
      <strong>Items</strong>
      <table>
        <thead><tr><th>Name</th><th>Code</th><th style="text-align:right;">Grams</th><th style="text-align:right;">Qty</th></tr></thead>
        <tbody id="itemsTbody"></tbody>
      </table>
    </div>

    <div id="qrcode"></div>
    <div class="muted" style="text-align:center;margin-top:6px;">Scan for nutrition payload</div>
  </div>

  <script src="qr-code.min.js"></script>
  <script>
  (function(){
    const qs = new URLSearchParams(location.search);
    const id = qs.get('id');
    const fmt = (n, d=2) => {
      const v = Number(n);
      if (!isFinite(v)) return '0';
      return v.toFixed(d);
    };
    const setText = (sel, text) => { const el = document.querySelector(sel); if (el) el.textContent = text; };

    // UI buttons
    document.getElementById('printBtn').onclick = () => window.print();

    async function load(){
      if (!id || !/^\d+$/.test(id)) {
        document.body.innerHTML = '<div class="receipt"><p>Missing or invalid order id.</p></div>';
        return;
      }
      let res, data;
      try {
        res = await fetch('../backend/orders_get.php?id='+encodeURIComponent(id), {cache:'no-store'});
        data = await res.json();
      } catch (e) {
        document.body.innerHTML = '<div class="receipt"><p>Failed to load receipt.</p></div>';
        return;
      }
      if (!data || data.error) {
        document.body.innerHTML = '<div class="receipt"><p>'+(data?.error || 'Order not found')+'</p></div>';
        return;
      }

      const o = data.order || {};
      const items = data.items || [];

      setText('#orderNo', '#'+o.id);
      // created_at is stored in UTC (per backend). Show as ISO UTC.
      setText('#createdAt', (o.created_at ? (o.created_at+' UTC') : ''));

      // Nutrition summary (safe textContent)
      const nutriEl = document.getElementById('nutri');
      nutriEl.innerHTML = ''; // clear
      const block = document.createElement('div');
      block.innerHTML =
        '<strong>Nutrition summary</strong><br/>' +
        'Energy: ' + fmt(o.energy_kj,1) + ' kJ (' + fmt(o.calories_kcal,0) + ' kcal)<br/>' +
        'Protein: ' + fmt(o.protein_g) + ' g, Fat: ' + fmt(o.fat_g) + ' g<br/>' +
        'Carbs: ' + fmt(o.carb_g) + ' g, Sugars: ' + fmt(o.sugars_g) + ' g<br/>' +
        'Sodium: ' + fmt(o.sodium_mg,0) + ' mg';
      nutriEl.appendChild(block);

      // Items table (if present)
      if (items.length) {
        document.getElementById('itemsWrap').style.display = '';
        const tb = document.getElementById('itemsTbody');
        tb.innerHTML = '';
        items.forEach(it => {
          const tr = document.createElement('tr');
          const tdName = document.createElement('td'); tdName.textContent = it.name || '';
          const tdCode = document.createElement('td'); tdCode.textContent = it.afcd_code || '';
          const tdGr = document.createElement('td'); tdGr.style.textAlign='right'; tdGr.textContent = fmt(it.grams, 0);
          const tdQty= document.createElement('td'); tdQty.style.textAlign='right'; tdQty.textContent = String(it.qty ?? 1);
          tr.append(tdName, tdCode, tdGr, tdQty);
          tb.appendChild(tr);
        });
      }

    const payload = [
  `NutriPOS #${o.id}`,
  `Energy: ${o.energy_kj} kJ (${o.calories_kcal} kcal)`,
  `Protein: ${o.protein_g} g`,
  `Fat: ${o.fat_g} g`,
  `Carb: ${o.carb_g} g`,
  `Sugars: ${o.sugars_g} g`,
  `Sodium: ${o.sodium_mg} mg`
].join('\n');

new QRCode(document.getElementById('qrcode'), {
  text: payload,
  width: 196,
  height: 196
});

    }

    load();
  })();
  </script>
</body>
</html>
